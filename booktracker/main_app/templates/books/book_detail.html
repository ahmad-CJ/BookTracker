{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book_detail.css' %}">
{% endblock %}

{% block content %}
<!-- Container for the detailed view of the book -->
<div class="detail-container">
    <div class="detail-header">
        <h1>Book Details</h1> <!-- Title of the page -->

        <div class="action-buttons">
            <!-- Edit button to redirect to the book update page -->
            <a href="{% url 'book_update' book.pk %}" class="btn btn-warning">Edit</a>

            <!-- Delete button to redirect to the book delete page -->
            <a href="{% url 'book_delete' book.pk %}" class="btn btn-danger">Delete</a>

            <!-- Back button to redirect to the book list -->
            <a href="{% url 'book_list' %}" class="btn btn-secondary">Back to List</a>
        </div>
    </div>

    <!-- Main content section with book details -->
    <div class="book-details">
        <div class="main-content">
            <div class="book-info-card">
                <h2 class="book-title">{{ book.title }}</h2> <!-- Display the book title -->

                <div class="book-meta">
                    <!-- display the book's author, genre, publication year, and read/unread status -->
                    <p><strong>Author:</strong> {{ book.author }}</p>
                    <p><strong>Genre:</strong> {{ book.genre }}</p>
                    <p><strong>Publication Year:</strong> {{ book.publication_year }}</p>
                    <p><strong>Status:</strong> 
                        <span class="status-badge {% if book.is_read %}read{% else %}unread{% endif %}">
                            {% if book.is_read %}✓ Read{% else %}❌ Unread{% endif %}
                        </span>
                    </p>
                </div>
                
                <div class="book-description">
                    <h3>Description:</h3>
                    <!-- display the book description with line breaks converted -->
                    <p>{{ book.description|linebreaks }}</p>
                </div>

                <!-- form to toggle the read/unread status of the book -->
                <form method="post" action="{% url 'toggle_read' book.id %}" class="toggle-form">
                    {% csrf_token %}
                    <!-- Button to mark the book as read or unread -->
                    <button type="submit" class="toggle-btn {% if book.is_read %}read{% else %}unread{% endif %}">
                        {% if book.is_read %}❌ Mark as Unread{% else %}✓ Mark as Read{% endif %}
                    </button>
                </form>
            </div>

            <!-- Reviews section -->
            <div class="reviews-section">
                <div class="reviews-header">
                    <h3>Reviews and Comments</h3>
                </div>

                <!-- form to add a new review for the book -->
                <form method="post" action="{% url 'add_review' book.id %}" class="review-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="id_rating" class="form-label">Rating:</label>
                        <div class="rating-control">
                            <!-- range input for rating, with live value display -->
                            <input type="range" name="rating" min="1" max="5" value="3" 
                                   class="rating-slider" id="id_rating" 
                                   oninput="document.getElementById('ratingValue').textContent = this.value + ' ⭐'">
                            <span id="ratingValue" class="rating-value">3 ⭐</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="id_comment" class="form-label">Comment:</label>
                        <!-- Textarea to write the review -->
                        <textarea name="comment" class="form-control" id="id_comment" 
                                  rows="3" placeholder="Write your review about this book..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Review</button>
                </form>

                <!-- display previous reviews for the book -->
                <div class="reviews-list">
                    <h4>Previous Reviews:</h4>
                    {% if book.reviews.all %}
                    
                    <!-- loop through the reviews and display each one -->
                        {% for review in book.reviews.all %}
                        <div class="review-card">
                            <div class="review-header">
                                <strong class="review-rating">{{ review.rating }} ⭐</strong> <!-- Display review rating -->
                                <small class="review-date">{{ review.date }}</small> <!-- Display review date -->
                            </div>
                            <p class="review-comment">{{ review.comment }}</p> <!-- Display review comment -->
                        </div>
                        {% endfor %}
                    {% else %}
                        <!-- If no reviews are available, display a message -->
                        <p class="no-reviews">No reviews yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar with quick information about the book -->
        <div class="sidebar">
            <div class="sidebar-card">
                <h3>Quick Info</h3>
                <div class="sidebar-info">
                    <p><strong>Total Reviews:</strong> {{ book.reviews.count }}</p> <!-- Display total number of reviews -->
                    <p><strong>Average Rating:</strong> 
                        {% if book.reviews.all %}
                            {{ book.reviews.all.0.rating }} ⭐ <!-- Display the average rating if reviews exist -->
                        {% else %}
                            No ratings
                        {% endif %}
                    </p>
                    <p><strong>Added On:</strong> {{ book.created_at|date:"Y-m-d" }}</p> <!-- Display the book's creation date -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
